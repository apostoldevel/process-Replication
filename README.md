Репликация (Replication)
-
**Процесс** для [Апостол CRM](https://github.com/apostoldevel/apostol-crm).

Описание
-
Процесс репликации подразумевает собой распространение изменений данных с главного сервера (мастер, master), на один или более подчиненных серверов (слейв, slave).

Необходимость в создании собственного механизма репликации данных вызвана тем, что стандартные решения не способны в полной мере удовлетворить поставленным задачам. Ключевым из которых является передача данных по каналам связи с не стабильной работой и низкой пропускной способностью.

Репликация состоит из трех шагов:

1. Мастер-сервер сохраняет изменения данных в журнале репликации (`replication.log`).
2. Слейв-сервер копирует эти данные в журнал ретрансляции (`replication.relay`) с указанием источника данных (`source`).
3. Слейв-сервер воспроизводит изменения из журнала ретрансляции, применяя их к собственным данным.

Установка
-
Следуйте указаниям по сборке и установке [Апостол CRM](https://github.com/apostoldevel/apostol-crm#%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%B8-%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0)

Настройка
-

### Мастер-сервер

Любой сервер может выступать в качестве Мастер-сервера, для этого необходимо:

1. Определиться со списком реплецируемых таблиц;
1. Активировать репликацию.

### Список таблиц

Посмотреть список доступных для репликации таблиц можно с помощью следующего запроса:

```postgresql
SELECT * FROM ReplicationTable ORDER BY schema, name;
```

Задействовать репликацию для таблицы можно с помощью следующего запроса:

```postgresql
SELECT replication.set_table('schema', 'table', true);
```
Этим же запросом можно и исключить таблицу из списка репликации передав третьим параметром `false`.

Пример:

```postgresql
SELECT replication.set_table('db', t.name, true) FROM (SELECT unnest(ARRAY['table1', 'table2', 'tableN']) AS name) AS t;
```

### Включение репликации

Для того, что-бы активировать репликацию на сервере необходимо выполнить следующий запрос:

```postgresql
SELECT replication.on();
```

Запрос создаст специальный триггер для активных таблиц из списка.

### Отключение репликации

Для того, что-бы отключить репликацию на сервере выполнить следующий запрос:

```postgresql
SELECT replication.off();
```

### Слейв-сервер

Слейв-сервер подключается к Мастер-серверу по [WebSocket API](https://github.com/apostoldevel/module-WebSocketAPI).

Для активации Слейв-сервера в фале конфигурации необходимо убедиться в наличии следующих настроек:
```
## Process: Replication
[process/Replication]
## default: false
enable=true

## Source name
#source=localhost

## Replication mode: master, slave
## default: slave
#mode=slave

auth=https://master-server.com
server=wss://master-server.com
provider=system
application=replication
oauth2=replication.json
```

Значения в параметрах `auth` и `server` должны соответствовать DNS-имени или IP-адресу Мастер-сервера.

Файл `replication.json` должен располагаться в папке `oauth2` каталога с настройками Слейв-сервера (как правило это `/etc/<project>`).

В этом файле указывается `client_id` и `client_secret` пользователя (OAuth2-клиента) зарегистрированного на Мастер-сервере. Обратите внимание на то, что бы пользователь был также включен в группу `replication` на Мастер-сервере.

Пример файла:

```json
{
  "type": "service_account",
  "issuers": ["accounts.master-server.com"],
  "scopes": ["scope"],
  "client_id": "<client_id>",
  "client_secret": "<client_secret>",
  "algorithm": "HS256",
  "auth_uri": "/oauth2/authorize",
  "token_uri": "/oauth2/token"
}
```

#### Режимы репликации

По умолчанию Слейв-сервер работает в режиме Слейв-Мастер. Это означает, что данные будут передаваться только от Мастер-сервера к Слейв-серверу.

Слейв-сервер можно настроить в режим работы Мастер-Мастер. Для этого нужно указать в параметре `mode` значение `master` и выполнить настройки репликации описанные выше в разделе [Мастер-сервер](#Мастер-сервер).

Можно, конечно, настроить два сервера друг на друга в режиме `slave`, но лучше придерживаться правила в котором только Слейв-сервер подключается к Мастер-серверу. Кроме того Слейв-сервер не всегда может быть доступен из внешней сети и иметь статический IP-адрес.